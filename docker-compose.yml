services:
  directory:
    build:
      context: ./src/directory
      dockerfile: Dockerfile
    container_name: oidc-directory
    restart: unless-stopped
    environment:
      PORT: 8080
      USERS_FILE: /app/config/users.json
      BEARER_TOKEN: ${DIRECTORY_BEARER_TOKEN:-sk-AKnZKbq1O9RYwEagYhARZWlrPpbMCvliO8H646DmndO2Phth}
    volumes:
      - ${DIRECTORY_USERS_FILE:-./docker/provider/users.json}:/app/config/users.json:ro
    ports:
      - "${DIRECTORY_PORT:-7080}:8080"
    networks:
      - oidc-net
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:8080/healthz || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 20s
    security_opt:
      - no-new-privileges:true

  provider:
    build:
      context: ./src/provider
      dockerfile: Dockerfile
    container_name: oidc-provider
    restart: unless-stopped
    environment:
      PORT: 8080
      ISSUER: http://provider:8080
      CLIENT_ID: ${PROVIDER_CLIENT_ID:-85125d57-a403-4fe2-84d8-62c6db9b6d73}
      CLIENT_SECRET: ${PROVIDER_CLIENT_SECRET:-+XiBpec4OAIeFBSbRdGaAGLNz6ZFfAbq}
      REDIRECT_URIS: http://localhost:${DEMO_PORT:-8080}/signin-oidc
      POST_LOGOUT_REDIRECT_URIS: http://localhost:${DEMO_PORT:-8080}/signout-callback-oidc
      DIRECTORY_TYPE: ${DIRECTORY_TYPE:-remote}
      DIRECTORY_BASE_URL: ${DIRECTORY_BASE_URL:-http://directory:8080}
      DIRECTORY_HEADERS: ${DIRECTORY_HEADERS:-{"Authorization":"Bearer sk-AKnZKbq1O9RYwEagYhARZWlrPpbMCvliO8H646DmndO2Phth"}}
      FEATURES_DEV_INTERACTIONS: false
      SQLITE_DB_PATH: /data/oidc.db
    ports:
      - "${PROVIDER_PORT:-9080}:8080"
    volumes:
      - provider-data:/data
    networks:
      - oidc-net
    depends_on:
      directory:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    security_opt:
      - no-new-privileges:true

  demo:
    build:
      context: ./src/demo
      dockerfile: Dockerfile
    container_name: oidc-demo
    restart: unless-stopped
    environment:
      ASPNETCORE_URLS: http://+:8080
      ASPNETCORE_ENVIRONMENT: Development
      OPENID__AUTHORITY: http://provider:8080
      OPENID__PUBLICORIGIN: http://localhost:${PROVIDER_PORT:-9080}
      OPENID__CLIENTID: ${PROVIDER_CLIENT_ID:-85125d57-a403-4fe2-84d8-62c6db9b6d73}
      OPENID__CLIENTSECRET: ${PROVIDER_CLIENT_SECRET:-+XiBpec4OAIeFBSbRdGaAGLNz6ZFfAbq}
      OPENID__REQUIREHTTPSMETADATA: false
      OPENID__SCOPES__0: openid
      OPENID__SCOPES__1: profile
      OPENID__SCOPES__2: email
    depends_on:
      provider:
        condition: service_healthy
    ports:
      - "${DEMO_PORT:-8080}:8080"
    networks:
      - oidc-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    security_opt:
      - no-new-privileges:true

networks:
  oidc-net:
    driver: bridge

volumes:
  provider-data:
    driver: local

{% extends 'layout.html' %}
{% set current_tab = 'users' %}
{% block content %}
<div x-data="app()" x-init="init()" class="space-y-4">
  <div class="flex justify-between items-center">
    <h2 class="text-xl font-semibold text-gray-900">Users</h2>
    <button @click="showCreateUserForm = true" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Add
      User</button>
  </div>

  <div class="bg-white rounded-lg shadow overflow-hidden">
    <table class="min-w-full">
      <thead class="bg-gray-100">
        <tr>
          <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Username</th>
          <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Display Name</th>
          <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Email</th>
          <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Status</th>
          <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        <template x-for="user in users" :key="user.id">
          <tr>
            <td class="px-6 py-4 text-sm text-gray-900" x-text="user.username"></td>
            <td class="px-6 py-4 text-sm text-gray-900" x-text="user.display_name"></td>
            <td class="px-6 py-4 text-sm text-gray-600">
              <template x-if="user.emails && user.emails.length > 0">
                <span x-text="user.emails[0].email"></span>
              </template>
            </td>
            <td class="px-6 py-4 text-sm">
              <span x-show="user.is_active" class="px-2 py-1 bg-green-100 text-green-800 rounded">Active</span>
              <span x-show="!user.is_active" class="px-2 py-1 bg-red-100 text-red-800 rounded">Inactive</span>
            </td>
            <td class="px-6 py-4 text-sm space-x-2">
              <a :href="`/users/edit?id=${user.id}`" class="text-blue-600 hover:text-blue-700">Edit</a>
              <button @click="deleteUser(user.id, user.username)"
                class="text-red-600 hover:text-red-700">Delete</button>
            </td>
          </tr>
        </template>
      </tbody>
    </table>
  </div>

  <!-- Create User Modal -->
  <div x-show="showCreateUserForm" class="fixed inset-0 bg-black/30 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg p-6 w-full max-w-md">
      <h3 class="text-lg font-semibold mb-4">Create User</h3>
      <div x-show="createError" class="mb-3 p-3 bg-red-50 border border-red-200 rounded text-red-700 text-sm"
        x-text="createError"></div>
      <div class="space-y-3">
        <input x-model="newUser.username" placeholder="Username *" required class="w-full border rounded px-3 py-2" />
        <input x-model="newUser.display_name" placeholder="Display Name" class="w-full border rounded px-3 py-2" />
        <input x-model="newUser.email" type="email" placeholder="Email" class="w-full border rounded px-3 py-2" />
        <input x-model="newUser.password" type="password" placeholder="Password *" required
          class="w-full border rounded px-3 py-2" />
        <select x-model="newUser.domain_id" class="w-full border rounded px-3 py-2">
          <option value="">Select Domain</option>
          <template x-for="domain in domains" :key="domain.id">
            <option :value="domain.id" x-text="domain.name"></option>
          </template>
        </select>
        <label class="inline-flex items-center gap-2">
          <input type="checkbox" x-model="newUser.is_active" />
          <span>Active</span>
        </label>
        <div>
          <div class="flex justify-between items-center mb-2">
            <label class="block text-sm font-medium text-gray-700">Custom Properties</label>
            <button @click="addProperty()" type="button" class="text-sm text-blue-600 hover:text-blue-700">+ Add
              Property</button>
          </div>
          <div class="space-y-2 max-h-40 overflow-y-auto">
            <template x-for="(prop, index) in newUserProperties" :key="index">
              <div class="flex gap-2">
                <select x-model="prop.key" @change="onPropertyKeyChange(index, $event.target.value)"
                  class="flex-1 border rounded px-2 py-1 text-sm">
                  <option value="">Select Key...</option>
                  <template x-for="stdKey in standardPropertyKeys" :key="stdKey.key">
                    <option :value="stdKey.key" x-text="stdKey.key + ' - ' + stdKey.description"></option>
                  </template>
                  <option value="__custom__">Custom Key...</option>
                </select>
                <input x-show="prop.key === '__custom__'" x-model="prop.customKey" placeholder="Custom Key"
                  class="flex-1 border rounded px-2 py-1 text-sm" />
                <input x-model="prop.value" placeholder="Value" class="flex-1 border rounded px-2 py-1 text-sm" />
                <button @click="removeProperty(index)" type="button"
                  class="text-red-600 hover:text-red-700 px-2">Ã—</button>
              </div>
            </template>
          </div>
        </div>
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button @click="showCreateUserForm=false; createError=null" class="px-4 py-2 border rounded">Cancel</button>
        <button @click="createUser()" class="px-4 py-2 bg-blue-600 text-white rounded">Create</button>
      </div>
    </div>
  </div>
</div>
<script>
  function app() {
    return {
      users: [],
      domains: [],
      standardPropertyKeys: [],
      showCreateUserForm: false,
      createError: null,
      newUser: { username: '', display_name: '', email: '', password: '', domain_id: '', is_active: true },
      newUserProperties: [],
      async init() {
        await this.loadDomains();
        await this.loadPropertyKeys();
        await this.loadUsers();
      },
      async loadPropertyKeys() {
        try {
          const resp = await csrfFetch('/api/property-keys/standard');
          if (resp.ok) {
            this.standardPropertyKeys = await resp.json();
          }
        } catch (err) {
          console.error('Error loading property keys:', err);
        }
      },
      async loadDomains() {
        const resp = await csrfFetch('/api/domains');
        if (resp.ok) {
          this.domains = await resp.json();
          // Auto-select default domain if available
          const defaultDomain = this.domains.find(d => d.is_default);
          if (defaultDomain) {
            this.newUser.domain_id = defaultDomain.id;
          }
        }
      },
      async loadUsers() {
        const resp = await csrfFetch('/api/users');
        if (resp.ok) {
          this.users = await resp.json();
        } else if (resp.status === 401) {
          window.location.href = '/login?redirectTo=' + encodeURIComponent(window.location.pathname);
        } else {
          console.error('Failed to load users:', resp.status);
          this.users = [];
        }
      },
      addProperty() {
        this.newUserProperties.push({ key: '', customKey: '', value: '' });
      },
      removeProperty(index) {
        this.newUserProperties.splice(index, 1);
      },
      onPropertyKeyChange(index, value) {
        if (value !== '__custom__') {
          this.newUserProperties[index].customKey = '';
        }
      },
      async createUser() {
        this.createError = null;

        // Validate required fields
        if (!this.newUser.username || !this.newUser.username.trim()) {
          this.createError = 'Username is required';
          return;
        }
        if (!this.newUser.password || !this.newUser.password.trim()) {
          this.createError = 'Password is required';
          return;
        }
        if (!this.newUser.domain_id) {
          this.createError = 'Domain is required';
          return;
        }

        try {
          const payload = {
            ...this.newUser,
            properties: this.newUserProperties.filter(p => {
              const key = p.key === '__custom__' ? p.customKey : p.key;
              return key && key.trim() !== '';
            }).reduce((acc, p) => {
              const key = p.key === '__custom__' ? p.customKey.trim() : p.key.trim();
              acc[key] = p.value;
              return acc;
            }, {})
          };

          const r = await csrfFetch('/api/users', {
            method: 'POST',
            body: JSON.stringify(payload)
          });

          if (r.ok) {
            this.showCreateUserForm = false;
            this.newUser = { username: '', display_name: '', email: '', password: '', domain_id: '', is_active: true };
            this.newUserProperties = [];
            // Reset to default domain if available
            const defaultDomain = this.domains.find(d => d.is_default);
            if (defaultDomain) {
              this.newUser.domain_id = defaultDomain.id;
            }
            await this.loadUsers();
          } else {
            const contentType = r.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
              try {
                const err = await r.json();
                this.createError = err.error || `Error: ${r.status}`;
              } catch (parseErr) {
                this.createError = `Server error (${r.status})`;
              }
            } else {
              if (r.status === 409) {
                this.createError = 'Username already exists';
              } else {
                this.createError = `Request failed (${r.status})`;
              }
            }
          }
        } catch (err) {
          this.createError = 'Network error occurred';
          console.error('Error creating user:', err);
        }
      },
      async deleteUser(id, username) {
        const confirmed = await window.confirmModal.show(
          'Delete User',
          `Are you sure you want to delete "${username}"? This action cannot be undone.`,
          'Delete'
        );
        if (!confirmed) return;

        const r = await csrfFetch(`/api/users/${id}`, { method: 'DELETE' });
        if (r.status === 204 || r.ok) {
          await this.loadUsers();
        } else {
          alert('Failed to delete user');
        }
      }
    }
  }
</script>
{% endblock %}
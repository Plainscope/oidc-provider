<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ title or 'Simple Directory' }}</title>
  {% if csrf_token %}
  <meta name="csrf-token" content="{{ csrf_token() }}">
  {% endif %}
  {% if auth_token %}
  <meta name="auth-token" content="{{ auth_token }}">
  {% endif %}
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script>
    window.csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || null;
    window.csrfFetch = async function (url, options = {}) {
      const headers = new Headers(options.headers || {});
      if (window.csrfToken) { headers.set('X-CSRFToken', window.csrfToken); }
      headers.set('Content-Type', headers.get('Content-Type') || 'application/json');
      // Get Authorization header from page context or session
      let authToken = document.querySelector('meta[name="auth-token"]')?.getAttribute('content');
      if (!authToken) {
        const rawToken = sessionStorage.getItem('directoryAuthToken');
        if (rawToken) {
          authToken = rawToken.startsWith('Bearer ') ? rawToken : `Bearer ${rawToken}`;
        }
      }
      if (authToken) { headers.set('Authorization', authToken); }
      return fetch(url, { ...options, headers });
    }
    // Check if user is authenticated - script is at the end of body, so DOM is already loaded
    const authToken = document.querySelector('meta[name="auth-token"]')?.getAttribute('content') ||
      sessionStorage.getItem('directoryAuthToken');
    const currentPath = window.location.pathname;

    // Don't check auth on login page or root
    if (currentPath !== '/login' && !currentPath.startsWith('/error')) {
      if (!authToken) {
        window.location.href = '/login?redirectTo=' + encodeURIComponent(currentPath);
      }
    }
    // Handle unauthorized responses
    window.addEventListener('fetch', (e) => {
      if (e.response && e.response.status === 401) {
        window.location.href = '/login?redirectTo=' + encodeURIComponent(window.location.pathname);
      }
    });
  </script>
</head>

<body class="bg-gray-50" x-data="layoutData()">
  <nav class="bg-white shadow">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center">
          <h1 class="text-2xl font-bold text-gray-900">Simple Directory</h1>
        </div>
        <div class="flex items-center gap-4">
          <a href="/"
            class="px-4 py-2 font-medium {{ 'border-b-2 border-blue-500 text-blue-600' if current_tab == 'users' else 'text-gray-600' }}">Users</a>
          <a href="/roles"
            class="px-4 py-2 font-medium {{ 'border-b-2 border-blue-500 text-blue-600' if current_tab == 'roles' else 'text-gray-600' }}">Roles</a>
          <a href="/groups"
            class="px-4 py-2 font-medium {{ 'border-b-2 border-blue-500 text-blue-600' if current_tab == 'groups' else 'text-gray-600' }}">Groups</a>
          <a href="/domains"
            class="px-4 py-2 font-medium {{ 'border-b-2 border-blue-500 text-blue-600' if current_tab == 'domains' else 'text-gray-600' }}">Domains</a>
          <a href="/audit"
            class="px-4 py-2 font-medium {{ 'border-b-2 border-blue-500 text-blue-600' if current_tab == 'audit' else 'text-gray-600' }}">Audit</a>
          <button @click="logout()" class="text-gray-600 hover:text-gray-900 font-medium" title="Sign out">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    {% block content %}{% endblock %}
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="hidden fixed inset-0 bg-black/30 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-lg max-w-sm w-full">
      <div class="p-6">
        <h3 id="confirmTitle" class="text-lg font-semibold text-gray-900 mb-2">Confirm Action</h3>
        <p id="confirmMessage" class="text-gray-600 mb-6"></p>
        <div class="flex justify-end gap-3">
          <button onclick="window.confirmModal.cancel()"
            class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancel</button>
          <button id="confirmBtn" onclick="window.confirmModal.confirm()"
            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Confirmation Dialog Manager
    window.confirmModal = {
      resolve: null,
      confirm() {
        document.getElementById('confirmModal').classList.add('hidden');
        if (this.resolve) { this.resolve(true); this.resolve = null; }
      },
      cancel() {
        document.getElementById('confirmModal').classList.add('hidden');
        if (this.resolve) { this.resolve(false); this.resolve = null; }
      },
      show(title, message, actionText = 'Confirm') {
        return new Promise((resolve) => {
          this.resolve = resolve;
          document.getElementById('confirmTitle').textContent = title;
          document.getElementById('confirmMessage').textContent = message;
          document.getElementById('confirmBtn').textContent = actionText;
          document.getElementById('confirmModal').classList.remove('hidden');
        });
      }
    };

    // Alpine.js layout data
    function layoutData() {
      return {
        logout() {
          sessionStorage.removeItem('directoryAuthToken');
          localStorage.removeItem('directoryAuthToken');
          window.location.href = '/login';
        }
      };
    }
  </script>
</body>

</html>
{% extends 'layout.html' %}
{% set current_tab = 'users' %}
{% block content %}
<div x-data="userEditPage()" x-init="init()" class="space-y-4">
  <h2 class="text-xl font-semibold text-gray-900">Edit User</h2>
  <div class="bg-white rounded-lg shadow p-6 space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <input x-model="user.display_name" placeholder="Display Name" class="border rounded px-3 py-2" />
      <input x-model="user.email" placeholder="Primary Email" class="border rounded px-3 py-2" />
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Roles</label>
      <div class="flex flex-wrap gap-2">
        <template x-for="role in roles" :key="role.id">
          <label class="inline-flex items-center gap-2 border rounded px-2 py-1">
            <input type="checkbox" :value="role.id" @change="toggleRole(role.id, $event.target.checked)"
              :checked="selectedRoles.includes(role.id)">
            <span x-text="role.name"></span>
          </label>
        </template>
      </div>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Groups</label>
      <div class="flex flex-wrap gap-2">
        <template x-for="group in groups" :key="group.id">
          <label class="inline-flex items-center gap-2 border rounded px-2 py-1">
            <input type="checkbox" :value="group.id" @change="toggleGroup(group.id, $event.target.checked)"
              :checked="selectedGroups.includes(group.id)">
            <span x-text="group.name"></span>
          </label>
        </template>
      </div>
    </div>
    <div x-show="error" class="mb-3 p-3 bg-red-50 border border-red-200 rounded text-red-600 text-sm" x-text="error">
    </div>
    <div class="flex justify-end gap-2">
      <a href="/" class="px-4 py-2 border rounded">Cancel</a>
      <button @click="save()" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
    </div>
  </div>
</div>
<script>
  function userEditPage() {
    const userId = new URLSearchParams(window.location.search).get('id');

    // Fallback fetch function if csrfFetch is not available
    const safeFetch = window.csrfFetch || fetch.bind(window);

    return {
      user: {}, roles: [], groups: [], selectedRoles: [], selectedGroups: [], error: null,
      async init() {
        try {
          const uRes = await safeFetch(`/api/users/${userId}`);
          if (!uRes.ok) {
            this.error = 'Failed to load user data';
            console.error(`User fetch failed with status ${uRes.status}`);
            return;
          }
          const u = await uRes.json();
          this.user = u; 
          this.selectedRoles = (u.roles || []).map(r => r.id); 
          this.selectedGroups = (u.groups || []).map(g => g.id);
          
          const rolesRes = await safeFetch('/api/roles');
          if (rolesRes.ok) {
            this.roles = await rolesRes.json();
          }
          
          const groupsRes = await safeFetch('/api/groups');
          if (groupsRes.ok) {
            this.groups = await groupsRes.json();
          }
        } catch (err) {
          this.error = 'Failed to load user data';
          console.error('Error loading user data:', err);
        }
      },
      toggleRole(id, on) { if (on) { if (!this.selectedRoles.includes(id)) this.selectedRoles.push(id); } else { this.selectedRoles = this.selectedRoles.filter(x => x !== id); } },
      toggleGroup(id, on) { if (on) { if (!this.selectedGroups.includes(id)) this.selectedGroups.push(id); } else { this.selectedGroups = this.selectedGroups.filter(x => x !== id); } },
      async save() {
        this.error = null;
        try {
          const payload = { display_name: this.user.display_name, email: this.user.email, role_ids: this.selectedRoles, group_ids: this.selectedGroups };
          const r = await safeFetch(`/api/users/${userId}`, { method: 'PATCH', body: JSON.stringify(payload) });
          if (r.ok) { window.location.href = '/'; }
          else {
            // Try to parse JSON response for detailed error message
            let errorMessage = 'Failed to update user';
            const contentType = r.headers.get('content-type');
            
            if (contentType && contentType.includes('application/json')) {
              try {
                const err = await r.json();
                errorMessage = err.error || `Server error: ${r.status}`;
              } catch (parseErr) {
                errorMessage = `Server error (${r.status}): Invalid response`;
              }
            } else {
              // Provide status-specific error messages for non-JSON responses
              if (r.status === 400) {
                errorMessage = 'Invalid request data';
              } else if (r.status === 401 || r.status === 403) {
                errorMessage = 'Not authorized to update user';
              } else if (r.status === 404) {
                errorMessage = 'User not found';
              } else if (r.status === 409) {
                errorMessage = 'Email already in use';
              } else if (r.status >= 500) {
                errorMessage = 'Server error - please try again later';
              } else {
                errorMessage = `Request failed (${r.status})`;
              }
            }
            this.error = errorMessage;
          }
        } catch (err) {
          this.error = 'Network error occurred';
          console.error('Error saving user:', err);
        }
      }
    }
  }
</script>
{% endblock %}
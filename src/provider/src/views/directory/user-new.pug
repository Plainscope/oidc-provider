extends layout

block content
  .card
    h1 Create New User
    
    if error
      .error-message= error
    
    form#user-form(method="POST", action="/directory/users/create")
      .form-section
        h2 Basic Information
        .form-grid
          .form-group
            label(for="username") Username <span class="required">*</span>
            input#username(type="text", name="username", required, autocomplete="off")
            .help-text Unique identifier for login
          
          .form-group
            label(for="password") Password <span class="required">*</span>
            input#password(type="password", name="password", required, autocomplete="new-password", minlength="8")
            .help-text Minimum 8 characters
          
          .form-group
            label(for="first_name") First Name
            input#first_name(type="text", name="first_name")
          
          .form-group
            label(for="last_name") Last Name
            input#last_name(type="text", name="last_name")
          
          .form-group
            label(for="display_name") Display Name
            input#display_name(type="text", name="display_name")
            .help-text Optional. Auto-generated from first and last name if empty
          
          .form-group
            label(for="domain_name") Domain
            select#domain_name(name="domain_name")
              option(value="local", selected) local
              if domains
                each domain in domains
                  option(value=domain)= domain
      
      .form-section
        h2 Email Address
        .form-grid
          .form-group
            label(for="email") Email <span class="required">*</span>
            input#email(type="email", name="email", required)
          
          .form-group
            label(for="email_verified") Email Verified
            select#email_verified(name="email_verified")
              option(value="false", selected) No
              option(value="true") Yes
      
      .form-section
        h2 Status
        .form-grid
          .form-group
            label(for="is_active") Account Status
            select#is_active(name="is_active")
              option(value="true", selected) Active
              option(value="false") Inactive
            .help-text Inactive users cannot log in
      
      .form-actions
        button.btn.btn-primary(type="submit") Create User
        a.btn.btn-secondary(href="/directory/users") Cancel
    
    script.
      // Auto-generate display name from first and last name
      const firstName = document.getElementById('first_name');
      const lastName = document.getElementById('last_name');
      const displayName = document.getElementById('display_name');
      
      function updateDisplayName() {
        if (!displayName.value || displayName.dataset.autoGenerated) {
          const first = firstName.value.trim();
          const last = lastName.value.trim();
          if (first || last) {
            displayName.value = `${first} ${last}`.trim();
            displayName.dataset.autoGenerated = 'true';
          }
        }
      }
      
      firstName.addEventListener('input', updateDisplayName);
      lastName.addEventListener('input', updateDisplayName);
      
      displayName.addEventListener('input', () => {
        if (displayName.value) {
          delete displayName.dataset.autoGenerated;
        }
      });
      
      // Form validation
      document.getElementById('user-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        
        // Convert boolean strings
        data.is_active = data.is_active === 'true';
        data.email_verified = data.email_verified === 'true';
        
        try {
          const response = await fetch('/directory/users/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          
          if (response.ok) {
            const result = await response.json();
            window.location.href = `/directory/users/${result.id}`;
          } else {
            const error = await response.json();
            showAlert(error.error || 'Failed to create user', 'Error');
          }
        } catch (err) {
          showAlert('Error: ' + err.message, 'Error');
        }
      });

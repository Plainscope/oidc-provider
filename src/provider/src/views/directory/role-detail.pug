extends layout

block content
  .card
    .header-actions
      div
        h1= role.name
        p(style="color: #718096; margin-top: 0.5rem;")= role.description || 'No description'
      a.btn.btn-secondary(href="/directory/roles") â† Back to Roles
    
    .section
      h2 Role Information
      .info-grid
        .info-item
          .info-label Role ID
          .info-value= role.id
        .info-item
          .info-label Name
          .info-value= role.name
        .info-item
          .info-label Description
          .info-value= role.description || 'N/A'
        .info-item
          .info-label Created At
          .info-value= new Date(role.created_at).toLocaleString()
    
    .section
      h2 Members (#{users && users.length ? users.length : 0})
      if users && users.length > 0
        div#users-list
          each user in users
            .user-item(data-user-id=user.id)
              .user-info
                .user-name= user.display_name || (user.first_name + ' ' + user.last_name).trim()
                .user-username= user.username
              button.remove-btn(type="button", title="Remove from role") Remove
      else
        p No users have this role yet.
      
      if availableUsers && availableUsers.length > 0
        .assignment-controls
          .form-group
            label(for="user-select") Add User:
            select#user-select(data-role-id=role.id)
              option(value="") Select a user...
              each user in availableUsers
                option(value=user.id)
                  = user.display_name || (user.first_name + ' ' + user.last_name).trim()
                  = ' (' + user.username + ')'
          button.btn.btn-primary.btn-sm#add-user-btn(type="button") Add
    
    script.
      const roleId = '#{role.id}';
      
      // Add user functionality
      document.getElementById('add-user-btn')?.addEventListener('click', async () => {
        const userSelect = document.getElementById('user-select');
        const userId = userSelect?.value;
        
        if (!userId) {
          showAlert('Please select a user', 'No User Selected');
          return;
        }
        
        try {
          const response = await fetch(`/directory/roles/${roleId}/users/${userId}`, { method: 'POST' });
          if (response.ok) {
            location.reload();
          } else {
            const data = await response.json();
            showAlert('Error: ' + (data.error || 'Failed to add user'), 'Error');
          }
        } catch (err) {
          showAlert('Error: ' + err.message, 'Error');
        }
      });
      
      // Remove user functionality
      document.querySelectorAll('#users-list .user-item').forEach(item => {
        item.querySelector('.remove-btn').addEventListener('click', async () => {
          const userId = item.dataset.userId;
          const userName = item.querySelector('.user-name').textContent.trim();
          
          showConfirm(`Remove user "${userName}" from this role?`, async () => {
            try {
              const response = await fetch(`/directory/roles/${roleId}/users/${userId}/remove`, { method: 'POST' });
              if (response.ok) {
                location.reload();
              } else {
                const data = await response.json();
                showAlert('Error: ' + (data.error || 'Failed to remove user'), 'Error');
              }
            } catch (err) {
              showAlert('Error: ' + err.message, 'Error');
            }
          }, 'Remove User from Role');
        });
      });

extends layout

block content
  .card
    h1 Edit User: #{user.username}
    
    if error
      .error-message= error
    
    .info-box
      strong Note: Username and User ID cannot be changed. Leave password empty to keep current password.
    
    form#user-form(method="POST", action=`/directory/users/${user.id}/update`)
      .form-section
        h2 Basic Information
        .form-grid
          .form-group
            label(for="username") Username
            input#username(type="text", name="username", value=user.username, disabled)
            .help-text Cannot be changed
          
          .form-group
            label(for="password") New Password
            input#password(type="password", name="password", autocomplete="new-password", minlength="8")
            .help-text Leave blank to keep current password
          
          .form-group
            label(for="first_name") First Name
            input#first_name(type="text", name="first_name", value=user.first_name || '')
          
          .form-group
            label(for="last_name") Last Name
            input#last_name(type="text", name="last_name", value=user.last_name || '')
          
          .form-group
            label(for="display_name") Display Name
            input#display_name(type="text", name="display_name", value=user.display_name || '')
          
          .form-group
            label(for="domain_name") Domain
            select#domain_name(name="domain_name")
              option(value="local", selected=(user.domain_name === 'local')) local
              if domains
                each domain in domains
                  option(value=domain, selected=(user.domain_name === domain))= domain
      
      .form-section
        h2 Status
        .form-grid
          .form-group
            label(for="is_active") Account Status
            select#is_active(name="is_active")
              option(value="true", selected=user.is_active) Active
              option(value="false", selected=!user.is_active) Inactive
            .help-text Inactive users cannot log in
      
      .form-actions
        button.btn.btn-primary(type="submit") Update User
        a.btn.btn-secondary(href=`/directory/users/${user.id}`) Cancel
    
    script.
      const userId = '#{user.id}';
      
      // Auto-update display name from first and last name
      const firstName = document.getElementById('first_name');
      const lastName = document.getElementById('last_name');
      const displayName = document.getElementById('display_name');
      
      function updateDisplayName() {
        if (!displayName.value || displayName.dataset.autoGenerated) {
          const first = firstName.value.trim();
          const last = lastName.value.trim();
          if (first || last) {
            displayName.value = `${first} ${last}`.trim();
            displayName.dataset.autoGenerated = 'true';
          }
        }
      }
      
      firstName.addEventListener('input', updateDisplayName);
      lastName.addEventListener('input', updateDisplayName);
      
      displayName.addEventListener('input', () => {
        if (displayName.value) {
          delete displayName.dataset.autoGenerated;
        }
      });
      
      // Form submission
      document.getElementById('user-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const data = {};
        
        // Only include non-empty values
        for (const [key, value] of formData) {
          if (value !== '') {
            data[key] = value;
          }
        }
        
        // Convert boolean strings
        if ('is_active' in data) {
          data.is_active = data.is_active === 'true';
        }
        
        try {
          const response = await fetch(`/directory/users/${userId}/update`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          
          if (response.ok) {
            window.location.href = `/directory/users/${userId}`;
          } else {
            const error = await response.json();
            showAlert(error.error || 'Failed to update user', 'Error');
          }
        } catch (err) {
          showAlert('Error: ' + err.message, 'Error');
        }
      });

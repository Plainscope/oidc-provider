name: "Build And Test"

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - src/**/*
      - test/**/*
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
    branches:
      - main
    paths:
      - src/**/*
      - test/**/*

permissions:
  checks: write
  pull-requests: write
  contents: read
  packages: write

jobs:
  build-and-test:
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false
    name: "Build And Test"
    runs-on: ubuntu-latest

    services:
      docker:
        image: docker:20.10.16
        options: --privileged
        ports:
          - 2375:2375
        env:
          DOCKER_TLS_CERTDIR: ""
        volumes:
          - /var/lib/docker

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /var/lib/docker
          key: ${{ runner.os }}-docker-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-docker-

      - name: Build and run services
        run: |
          docker compose up -d --build
        env:
          DIRECTORY_BEARER_TOKEN: ${{ secrets.DIRECTORY_BEARER_TOKEN }}
          PROVIDER_CLIENT_ID: ${{ secrets.PROVIDER_CLIENT_ID }}
          PROVIDER_CLIENT_SECRET: ${{ secrets.PROVIDER_CLIENT_SECRET }}

      - name: Wait for services to be healthy
        run: |
          # Wait for services to be healthy
          docker compose exec -T provider sh -c '
            until curl -f http://localhost:8080/healthz; do
              echo "Waiting for provider service to be healthy..."
              sleep 5
            done
          '
          docker compose exec -T directory sh -c '
            until curl -f http://localhost:8080/healthz; do
              echo "Waiting for directory service to be healthy..."
              sleep 5
            done
          '

      - name: Install test dependencies
        run: npm install
        working-directory: ./test

      - name: Install Playwright system dependencies
        run: npx playwright install-deps
        working-directory: ./test

      - name: Install Playwright browsers
        run: npm run playwright:install
        working-directory: ./test

      - name: Run tests
        run: npm run test:e2e
        working-directory: ./test

      - name: Publish Playwright JUnit summary
        if: always()
        uses: mikepenz/action-junit-report@v3
        with:
          report_paths: ./test/playwright-report/results.xml
          check_name: Playwright Tests

      - name: Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: playwright-html-report
          path: ./test/playwright-report/html

      - name: Tear down services
        if: always()
        run: docker compose down -v

      - name: Generate logs on failure
        if: failure()
        run: |
          docker compose logs > build-and-test-logs.txt
        continue-on-error: true

      - name: Upload logs artifact
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          path: build-and-test-logs.txt

  push-docker-images:
    name: "Build and Push Docker Images"
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    concurrency:
      group: docker-push-${{ github.ref }}
      cancel-in-progress: false

    strategy:
      matrix:
        image:
          - name: provider
            context: ./src/provider
            dockerfile: ./src/provider/Dockerfile
          - name: directory
            context: ./src/directory
            dockerfile: ./src/directory/Dockerfile
          - name: demo
            context: ./src/demo
            dockerfile: ./src/demo/Dockerfile

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Extract version from package.json
        id: package-version
        run: |
          VERSION=$(jq -r '.version' src/provider/package.json)
          echo "version=v${VERSION}" >> $GITHUB_OUTPUT
          echo "Version extracted: v${VERSION}"
      
      - name: Prepare repository owner
        id: repo-owner
        run: |
          echo "owner_lc=${OWNER,,}" >> $GITHUB_OUTPUT
        env:
          OWNER: ${{ github.repository_owner }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: all

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ghcr.io/${{ steps.repo-owner.outputs.owner_lc }}/simple-oidc-${{ matrix.image.name }}
          tags: |
            type=raw,value=${{ steps.package-version.outputs.version }}
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: ${{ matrix.image.context }}
          file: ${{ matrix.image.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64
